---
title: "Assignment 01: Exploratory Data Analysis"
author: "Flemming Wu"
date: "`r Sys.Date()`"
output: github_document
always_allow_html: true
---
#### We will work with air pollution data from the U.S. Environmental Protection Agency (EPA). The primary question you will answer is whether daily concentrations of PM 2.5 (particulate matter air pollution with aerodynamic diameter less than 2.5 m) have decreased in California over the last 15 years (from 2004 to 2019).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
setwd("~/Desktop/PM566/GitHub/01-assignment")
```

```{r Load Libraries, message = FALSE}
library(tidyverse)
library(leaflet)
library(webshot)
```


##### 1. Read in the data using data.table(). For each of the two datasets, check the dimensions, headers, footers, variable names, and variable types. Check for any data issues, particularly in the key variable you are analyzing. Make sure you write up a summary of all of your findings.

```{r Downloading and reading in csv files, message=FALSE}
if(!file.exists("data_2004.csv")){
  download.file("https://raw.githubusercontent.com/flemm0/PM_566/main/01-assignment/data_2004.csv", destfile = "data_2004.csv", method="libcurl", timeout = 60)
}

if(!file.exists("data_2019.csv")){
  download.file("https://raw.githubusercontent.com/flemm0/PM_566/main/01-assignment/data_2019.csv", destfile = "data_2019.csv", method="libcurl", timeout=60)
}

data_2004 <- data.table::fread("data_2004.csv")
data_2019 <- data.table::fread("data_2019.csv")
```

```{r Check dimensions}
paste("2004 data:", ncol(data_2004), "variables", nrow(data_2004), "observations")
paste("2019 data:", ncol(data_2019), "variables", nrow(data_2019), "observations")
```


```{r Checking ns}
dim(data_2019)[1]/dim(data_2004)[1]
```
There are almost 3 times as many observations for PM 2.5 concentration in 2019 compared to 2004.

\
Check headers and footers.
```{r check head and tail for 2004}
head(data_2004)
tail(data_2004)
```

```{r check head and tail for 2019}
head(data_2019)
tail(data_2019)
```

\
Check variables.
```{r Check variables for 2004 data}
str(data_2004)
```

```{r Check variables for 2019 data}
str(data_2019)
```
It looks like some of the column names are separated by space, so will update them to be syntactically valid.
```{r Update column names}
names(data_2004) <- make.names(names(data_2004))
names(data_2019) <- make.names(names(data_2019))
```

Checking Key Variable: PM 2.5 Concentration
```{r Check PM 2.5 concentration values for 2004}
summary(data_2004$Daily.Mean.PM2.5.Concentration)

table(data_2004$Daily.Mean.PM2.5.Concentration) %>% head()
```
One observation for PM 2.5 concentration in 2004 is negative.

```{r Check the maximum values for 2004}
quantile(data_2004$Daily.Mean.PM2.5.Concentration, seq(0, 1, 0.1))
```
Looks like 10% of the 2004 data lie between high PM 2.5 concentration levels of 27 and 251.


```{r Check PM 2.5 concentration values for 2019}
summary(data_2019$Daily.Mean.PM2.5.Concentration)

table(data_2019$Daily.Mean.PM2.5.Concentration) %>% head(15)
```
Looks like 2019 has many more PM 2.5 concentration observations that are below 0.

```{r Check the maximum values for 2019}
quantile(data_2019$Daily.Mean.PM2.5.Concentration, seq(0, 1, 0.1))
```
10% of the data in 2019 lie between concentration levels of 14.2 and 120.9. Additionally, the maximum 2.5 concentration observation is less than half that of the 2004 data. This is plausible due to increase of effort to reduce air pollution levels. For example, the EPA standard for PM 2.5 concentration post-1997 was 65 ug/m3 and was lowered to 35 ug/m3 since 2006.\

The negative PM 2.5 concentration levels pose a problem for answering the question and will be removed later on.







##### 2. Combine the two years of data into one data frame. Use the Date variable to create a new column for year, which will serve as an identifier. Change the names of the key variables so that they are easier to refer to in your code.

Changing dates to datetime type and creating year column.
```{r Changing dates to datetime type and creating year column}
data_2004 <- mutate(data_2004, Date = as.Date(Date, "%m/%d/%Y"))
data_2004$year <- format(as.Date(data_2004$Date, format="%m/%d/%Y"),"%Y")


data_2019 <- mutate(data_2019, Date = as.Date(Date, "%m/%d/%Y"))
data_2019$year <- format(as.Date(data_2019$Date, format="%m/%d/%Y"),"%Y")
```

Concatenate data frames.
```{r Rbind to concatenate data frames and change column names}
df_all <- rbind(data_2004, data_2019)
```

Change column names.
```{r Change names of key variables}
df_all <- rename(df_all, 
      "PM2.5Concentration" = "Daily.Mean.PM2.5.Concentration",
       "lat" = "SITE_LATITUDE",
       "lon" = "SITE_LONGITUDE")
```



##### 3. Create a basic map in leaflet() that shows the locations of the sites (make sure to use different colors for each year). Summarize the spatial distribution of the monitoring sites.

```{r Plotting leaflet, cache = TRUE}

pal <- colorFactor(
  palette = c('red', 'blue'),
  domain = df_all$year
)

leaflet(df_all) %>%
  addProviderTiles('OpenStreetMap') %>%
  addCircles(lat=~lat,lng=~lon, color = ~pal(year)) %>%
  addLegend(pal = pal, values = ~year)
```
From this plot, it is evident that there are more sites recording PM 2.5 concentration levels in 2019 than compared to 2004. This makes sense, given an increase in air pollution reduction efforts over time. Additionally, the sites in 2019 seem to be more evenly spread around California, instead of having most monitors near the large population centers in Los Angeles, San Francisco, and San Diego.


##### 4. Check for any missing or implausible values of PM 2.5 in the combined dataset. Explore the proportions of each and provide a summary of any temporal patterns you see in these observations.

```{r}
sum(is.na(df_all$PM2.5Concentration))
```
No missing values in data frame.


Take a closer look at sites giving negative PM 2.5 concentration readings:
```{r View negative readings by year and location, message=FALSE}
df_all %>%
  filter(PM2.5Concentration < 0) %>%
  group_by(Site.Name, year) %>%
  summarise(negative_readings = n()) %>%
  arrange(desc(negative_readings))
```
Check proportion of implausible data by year.
```{r Check proportion of implausible data}
paste(sum(with(df_all, PM2.5Concentration < 0 & year == "2019")) / nrow(filter(df_all, year == "2019")) * 100, "percent of 2019 data is negative")

paste(sum(with(df_all, PM2.5Concentration < 0 & year == "2004")) / nrow(filter(df_all, year == "2004")) * 100, "percent of 2004 data is negative")

```

For measurements of __concentration__ of particulate matter in the air, it seems implausible to have a negative observations. Remove from the data.

```{r filter out negative values for PM 2.5}
df_all <- df_all %>%
  filter(PM2.5Concentration > 0)
```


Check temporal patterns.
```{r Check temporal patterns, message = FALSE}

require(gridExtra)

p1 <- ggplot(data = filter(df_all, year == "2004"), mapping = aes(x = Date, y = PM2.5Concentration)) +
  geom_jitter(col = "red", size = 0.1) +
  geom_smooth(col = "black")

p2 <- ggplot(data = filter(df_all, year == "2019"), mapping = aes(x = Date, y = PM2.5Concentration)) +
  geom_jitter(col = "blue", size = 0.1) +
  geom_smooth(col = "black") +
  ylim(0, 250)

grid.arrange(p1, p2, ncol=2)

```
The temporal patterns look similar in both years, with spikes in January, April, July, and at the end of the year starting in October. The spikes in PM 2.5 concentration are larger in 2004 than in 2019.






##### 5. Explore the main question of interest at three different spatial levels. Create exploratory plots (e.g. boxplots, histograms, line plots) and summary statistics that best suit each level of data. Be sure to write up explanations of what you observe in these data.

state\
county\
site in Los Angeles\

Plot data for whole state.
```{r Plot data for whole state}
ggplot(data = df_all) +
  geom_bar(mapping = aes(x = PM2.5Concentration, fill=year)) +
  coord_cartesian(xlim = c(0, 100))
```
Both the histograms for 2019 and 2004 data are right-skewed with a peak at around 2.5 concentration of 10, however, the 2004 data contains many more PM 2.5 concentration observations above 13.


Plot PM 2.5 concentration by county.
```{r Plotting PM2.5 Concentrations for all counties}
ggplot(df_all, mapping = aes(x = COUNTY, y = PM2.5Concentration, color = year)) +
  geom_jitter(size = 0.3) +
  theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1))
```
From the plot, it can be seen that for many counties, there are many more high PM 2.5 concentration observations in 2004 than in 2019. Marin county holds the highest PM 2.5 concentration observation in the data set at above 250.



Look at sites in Los Angeles County.

```{r Validating site names}
lac <- df_all %>%
  filter(COUNTY == "Los Angeles")

lac %>%
  select(Site.Name) %>%
  unique()
```
One of the sites is missing a name.


```{r View coordinates for missing site name}
filter(lac, Site.Name == "") %>%
  select(Site.Name, lat, lon) %>% 
  unique()
```

From looking at Google Maps and matching the latitude and longitude, it seems as though the coordinates 34.01407, -118.0606 are close to the Pico Rivera #2 site, leading me to suspect that the unnamed site is Pico Rivera #1.

I validated this by checking the AQS website for a monitoring station at this location. https://epa.maps.arcgis.com/apps/webappviewer/index.html?id=5f239fd3e72f424f98ef3d5def547eb5&extent=-146.2334,13.1913,-46.3896,56.5319 The monitor is inactive now, but was active in 2004. Additionally, it wasn't given a site name, but the website says the city is "Pico Rivera". Will update this information in the data set to accurately reflect the site location.

```{r Replacing empty site name with "Pico Rivera}

lac$Site.Name <- replace(lac$Site.Name, lac$Site.Name == "", "Pico Rivera")
```

Plotting sites in Los Angeles County.
```{r Plot data in Los Angeles County}
ggplot(data = lac, mapping = aes(x = Site.Name, y = PM2.5Concentration, fill = year)) +
  geom_boxplot(outlier.size = 0.1) +
  theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1))
```
For the sites that have recordings in both 2004 and 2019, the median observations for 2004 are all higher than the median for observations for 2019. Additionally, the median across sites in Los Angeles County for 2004 is at about PM 2.5 concentration of 15, whereas the median across sites in 2019 are about 10.